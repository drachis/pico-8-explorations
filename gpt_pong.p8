pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
ball =  {x=64, y=64, dx=2, dy=2, size=4, maxspeed=6, color=0, color_active = 7, color_inactive=5}
paddle1 = {y = 60, height = 20, color = 14, colorfill=2, default_color = 14, hit_timer = 0, hit=false, score=0,score_timer=0}
paddle2 = {y = 60, height = 20, color = 12, colorfill=1, default_color = 12, hit_timer = 0, hit=false, score=0,score_timer=0}
score_color = 10
paddle_width=4
paddle_speed=2
    
function _init()
    reset_ball()
    music(0,nil,2)
    -- initialization
end

function _draw()
    cls(0)  -- Clear the screen with color 0 (black)
    -- Dashed line
    for line_y = 0, 127, 8 do
        rectfill(63, line_y, 64, line_y + 4, 5)
    end
  -- Draw paddles
    rectfill(5, paddle1.y, 5 + paddle_width, paddle1.y + paddle1.height, paddle1.colorfill)
    rect(5, paddle1.y, 5 + paddle_width, paddle1.y + paddle1.height, paddle1.color)
    rectfill(122 - paddle_width, paddle2.y, 122, paddle2.y + paddle2.height, paddle2.colorfill)
    rect(122 - paddle_width, paddle2.y, 122, paddle2.y + paddle2.height, paddle2.color)

    -- Draw the ball
    if paddle1.hit or paddle2.hit  then
        if paddle1.hit_timer > 0 then
            ball.color = paddle1.default_color
        elseif paddle2.hit_timer > 0 then
            ball.color = paddle2.default_color
        else
            ball.color = ball.color_active
        end
    else
        ball.color = ball.color_inactive
    end
    
    rectfill(ball.x - ball.size / 2, ball.y - ball.size / 2, 
             ball.x + ball.size / 2, ball.y + ball.size / 2, 
             ball.color)  -- Ball
    
    -- Draw the scores
    if paddle1.score_timer % 5 == 0 then
        print(paddle1.score, 30, 10, paddle1.default_color)  -- Player 1 score on the left
    else
        print(paddle1.score, 30, 10, score_color)  -- Player 1 score on the left
    end
    if paddle2.score_timer % 5 == 0 then
        print(paddle2.score, 90, 10, paddle2.default_color)  -- Player 2 score on the right
    else
        print(paddle2.score, 90, 10, score_color)  -- Player 2 score on the right
    end
end

function _update()
    ball.x += ball.dx
    ball.y += ball.dy

    -- Ball bouncing off the top and bottom edges
    if ball.y - ball.size/2 <= 0 or ball.y + ball.size/2 >= 127 then
        ball.dy *= -1
        -- Manually clamping the ball position
        ball.y = max(ball.size/2, min(ball.y, 127 - ball.size/2))
    end

    handle_paddle_collision(paddle1, 5, 10)
    handle_paddle_collision(paddle2, 122 - paddle_width, 122)

    update_paddle_color(paddle1)
    update_paddle_color(paddle2)

    control_paddles()

    -- Score update when the ball goes out of bounds
    if ball.x < 0 then
        if paddle2.hit then  -- Check if player 2 has hit the ball
            paddle2.score += 1
            paddle2.score_timer = 15
            sfx(2)
        end
        reset_ball()
    elseif ball.x > 127 then
        if paddle1.hit then  -- Check if player 1 has hit the ball
            paddle1.score += 1
            paddle1.score_timer = 15
            sfx(2)
        end
        reset_ball()
    end
    if paddle1.score_timer >0 then
        paddle1.score_timer -=1
    end
    if paddle2.score_timer >0 then
        paddle2.score_timer -=1
    end
end

function control_paddles()
    -- Player 1 controls (W and S)
    if btn(2, 1) and paddle1.y > 0 then
        paddle1.y -= paddle_speed
    end
    if btn(3, 1) and paddle1.y + paddle1.height < 127 then
        paddle1.y += paddle_speed
    end
    -- Ensure paddle stays within the screen
    paddle1.y = max(0, min(paddle1.y, 127 - paddle1.height))

    -- Player 2 controls (Arrow Keys)
    if btn(2, 0) and paddle2.y > 0 then
        paddle2.y -= paddle_speed
    end
    if btn(3, 0) and paddle2.y + paddle2.height < 127 then
        paddle2.y += paddle_speed
    end
    -- Ensure paddle stays within the screen
    paddle2.y = max(0, min(paddle2.y, 127 - paddle2.height))
end


function reset_ball()
    ball.x = 64
    ball.y = 64
    -- Randomize horizontal direction with equal probability of left or right
    ball.dx = rnd(2) < 1 and -2 or 2
    -- Randomize vertical direction with a small initial value to avoid immediate edge collision
    local angle = rnd(0.4) - 0.2  -- Small angle variation
    ball.dy = 2 * angle
    -- Ensure the initial vertical movement isn't too flat to avoid immediate teleport to paddles
    if abs(ball.dy) < 1 then
        ball.dy = ball.dy < 0 and -1 or 1
    end
    paddle1.hit = false  -- Reset hit flags on ball reset
    paddle2.hit = false
end

function handle_paddle_collision(paddle, x_min, x_max)
    local ball_left = ball.x - ball.size/2
    local ball_right = ball.x + ball.size/2
    local ball_top = ball.y - ball.size/2
    local ball_bottom = ball.y + ball.size/2

    -- Only check for a collision if the paddle's hit_timer is 0
    if paddle.hit_timer == 0 and
       ((ball.dx < 0 and ball_right > x_min and ball_left < x_max) or
        (ball.dx > 0 and ball_left < x_max and ball_right > x_min)) and
       ball_bottom > paddle.y and ball_top < paddle.y + paddle.height then
        
        ball.dx *= -1  -- Reverse the horizontal direction
        local hit_pos = (ball.y - (paddle.y + paddle.height / 2)) / (paddle.height / 2)
        ball.dy = ball.dy + hit_pos  -- Adjust the vertical direction based on hit position
        if ball.dy > 0 then --limit the ball's speed
            ball.dy = min(ball.dy,ball.maxspeed)
        else
            ball.dy = max(ball.dy,-ball.maxspeed)
        end
        -- Reposition the ball to prevent sticking
        if ball.dx < 0 then
            ball.x = x_min - ball.size / 2 - 1
        else
            ball.x = x_max + ball.size / 2 + 1
        end

        -- Update the paddle's color and start the hit timer
        paddle.color = paddle.colorfill
        paddle.hit_timer = 15  -- Start or reset the hit timer
        paddle.hit = true  -- Set the hit flag for this paddle
        sfx(0)
    end
    -- Decrement the hit_timer if it is greater than 0
    if paddle.hit_timer > 0 then
        paddle.hit_timer -= 1
    end
end

function update_paddle_color(paddle)
    if paddle.hit_timer > 0 then
        paddle.hit_timer -= 1  -- Decrement the timer
    else
        paddle.color = paddle.default_color  -- Restore the default color
    end
end
__label__
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000eee000000000000000000000000000000550000000000000000000000000cc000000000000000000000000000000000000
000000000000000000000000000000e0e0000000000000000000000000000005500000000000000000000000000c000000000000000000000000000000000000
000000000000000000000000000000e0e0000000000000000000000000000005500000000000000000000000000c000000000000000000000000000000000000
000000000000000000000000000000e0e0000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000
000000000000000000000000000000eee000000000000000000000000000000000000000000000000000000000ccc00000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccc00000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c111c00000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c111c00000
0000000000000000000000000000000000000000000000000000000000000005500000000000000000000000000000000000000000000000000000c111c00000
0000000000000000000000000000000000000000000000000000000000000005500000000000000000000000000000000000000000000000000000c111c00000
0000000000000000000000000000000000000000000000000000000000000005500000000000000000000000000000000000000000000000000000c111c00000
0000000000000000000000000000000000000000000000000000000000000005500000000000000000000000000000000000000000000000000000c111c00000
0000000000000000000000000000000000000000000000000000000000000005500000000000000000000000000000000000000000000000000000c111c00000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c111c00000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c111c00000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c111c00000
0000000000000000000000000000000000000000000000000000000000000005500000000000000000000000000000000000000000000000000000c111c00000
0000000000000000000000000000000000000000000000000000000000000005500000000000000000000000000000000000000000000000000000c111c00000
0000000000000000000000000000000000000000000000000000000000000005500000000000000000000000000000000000000000000000000000c111c00000
0000000000000000000000000000000000000000000000000000000000000005500000000000000000000000000000000000000000000000000000c111c00000
0000000000000000000000000000000000000000000000000000000000000005500000000000000000000000000000000000000000000000000000c111c00000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c111c00000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c111c00000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c111c00000
0000000000000000000000000000000000000000000000000000000000000005500000000000000000000000000000000000000000000000000000c111c00000
0000000000000000000000000000000000000000000000000000000000000005500000000000000000000000000000000000000000000000000000ccccc00000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000eeeee0000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000e222e0000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000e222e0000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000e222e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000e222e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000e222e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000e222e0000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000e222e0000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000e222e0000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000e222e0000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000e222e0000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000e222e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000e222e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000e222e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000e222e0000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000e222e0000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000e222e0000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000e222e0000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000e222e0000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000e222e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000eeeee0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000777770000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000777770000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000055000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

__sfx__
480100001f372213702c00020000070000400002000000000000002000030000000000000000000000018000110000e0000d0000c0000b0000a00000000000000000001000000000000002000000000000000000
00040000306102f62000600052000020025100001001c100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000e0000304103443037430374300d200352002f200282001f2003220029500295003a10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000400002dc6030c6034c6039c6037c6034c6030c602dc6034c6037c6039c6037c6034c6030c602dc6034c602dc6030c6034c6039c6037c6034c6030c6039c6034c6037c6039c6037c6034c6030c602dc6033c60
__music__
03 41420344
00 41424344
00 41424344
03 41424344
00 01424344

